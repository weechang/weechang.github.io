---
title: AxonFramework消息、命令和事件
date: 2018-08-17 16:38:47
categories: AxonFramework
tags: [AxonFramework, DDD, CQRS]
author: 勇赴
---

## 消息传送的概念
消息是Axon的核心概念之一。组件之间的所有通信都使用消息对象完成。这为这些组件提供了位置透明性，在必要时需要能够进行扩展和分发这些组件。

尽管所有这些消息都实现了消息接口，但不同类型的消息及其处理方式之间有明显的区别。所有消息包含payload、元数据和唯一标识符。消息的payload是消息的功能说明。该对象的类名组合与它所携带的数据，描述了消息的应用程序的含义。元数据允许你描述正在发送消息的上下文。例如，你可以存储跟踪信息，以允许跟踪消息的来源或原因。你还可以存储信息以描述正在执行命令的安全上下文。

<!-- more -->

><b>注意</b>
注意所有消息都是不可变的。将数据存储在一个消息中，实际上意味着在前一个消息的基础上，创建一个添加了额外信息的新消息。这保证了消息在多线程和分布式环境中使用是安全的。

## 命令
命令描述改变应用程序状态的意图。命令用一个CommandMessage来包装POJO（最好是只读的）来实现。

命令总是有一个确切的目的地。虽然发送者并不关心由哪个组件来处理命令或该组件驻留在哪里，但它可能对它的结果感兴趣。这就是命令总线上发送命令消息后，允许返回结果的原因。

## 事件
事件是描述应用程序中已经发生的事情的对象。聚合是事件的典型来源。当聚合中发生重要的事情时，它将引发一个事件。在Axon Framework中，事件可以是任何对象。非常希望你能确保所有的事件都是可序列化的。

当事件被分发时，Axon把他们包装在一个EventMessage中。实际使用的消息类型取决于事件的来源。当一个事件是由一个聚合引发时，它被包装在DomainEventMessage（继承自EventMessage）中。所有其他事件都被包装在一个EventMessage中。除了像唯一标识这种常见的消息属性，EventMessage还包含一个时间戳。DomainEventMessage额外包含类型和聚合的标识符，它还在聚合的事件流中包含事件的序号,以允许重现事件的顺序。

><b>注意</b>
尽管DomainEventMessage总包含一个对聚合标识符的引用,你也应该包括实际事件本身的标识符。EventStore通过DomainEventMessage中的标识符来存储事件，标识符可能并不总是会提供一个可靠值用于其他目标。

原始事件对象存储为EventMessage的payload。紧挨着的payload,你可以将信息存储在一个事件消息的元数据中。元数据的目的是存储关于事件的额外信息,而不是业务信息。审计信息就是一个典型的例子。它可以让你看到在哪些情况下，一个事件会被引发，比如用户帐户触发进程，或处理事件的机器名称。

><b>注意</b>
一般来说，你不应该基于事件消息的元数据中的信息进行业务决策。如果是这样的话，你可能有附加的信息，而不是事件本身的一部分信息。元数据通常用于报告、审计和跟踪。


虽然不是强制性的，但让领域事件不可变是一种很好的做法，最好是将所有字段声明为final并在构造函数中初始化。如果事件构造太麻烦可考虑使用建造者模式(Builder pattern )。

><b>注意</b>
虽然领域事件在技术上表示状态的变化,你也应该试图在事件中捕捉状态意图。一个好的实践是使用一个抽象的领域事件实现来捕获某些状态已经改变了这一事实,并使用一个抽象类具体的sub-implementation来表示变化的意图。例如,你可以有一个AddressChangedEvent抽象类，并用实现ContactMovedEvent和AddressCorrectedEvent这两个子类来达到捕获状态变化的意图。一些监听器不关心这些意图(例如,数据库更新事件监听器)，将监听抽象类型。其他关心这些意图监听器，它们将监听具体的子类(例如发送一个地址变更确认电子邮件给消费者)。
{% asset_img state_change.jpg State change %}

当在事件总线分发事件时,你需要把它包装在一个事件消息中。GenericEventMessage是一个允许你将你的事件包装到一个消息的实现。你可以使用构造函数,或静态方法：asEventMessage()。 后者检查给出的参数是否已经实现了消息接口，如果是这样，它直接返回（如果它实现了EventMessage），或者返回一个使用给定消息的payload和元数据来实例化的GenericEventMessage。如果一个事件通过聚合发布，Axon将自动把事件包装在一个DomainEventMessage中，包含聚合的标识符,类型和序列号。

作者：勇赴
链接：https://www.jianshu.com/p/e7abb5a228e9
來源：简书
简书著作权归作者所有，任何形式的转载都请联系作者获得授权并注明出处。